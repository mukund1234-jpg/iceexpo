{% extends "base.html" %}
{% block content %}

<!-- Tailwind container -->
<div class="min-h-screen py-10 px-6">
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- Webcam Capture Section -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">

      <div class="p-6 text-center">
        <!-- Video -->
        <video id="webcam" autoplay playsinline muted
          class="w-full max-w-lg mx-auto rounded-xl border border-gray-300 bg-black object-contain"></video>

        <!-- Hidden Canvas -->
        <canvas id="canvas" class="hidden"></canvas>

        <!-- Preview -->
        <img id="captured-preview" src="" alt="Captured"
          class="hidden mt-4 w-full max-w-lg mx-auto rounded-xl border-2 border-purple-400 shadow-lg transition-all duration-300" />

        <!-- Buttons -->
        <div class="mt-6 flex justify-center gap-3">
          <button id="capture-btn"
            class="px-5 py-2 rounded-full text-white font-semibold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 hover:scale-105 transition"
            onclick="captureImage()">
            <i class="bi bi-camera"></i> Capture
          </button>

          <button id="send-btn"
            class="hidden px-5 py-2 rounded-full text-white font-semibold bg-gradient-to-r from-emerald-400 to-green-500 hover:scale-105 transition"
            onclick="sendImage()">
            <i class="bi bi-upload"></i> Send
          </button>

          <button id="retake-btn"
            class="hidden px-5 py-2 rounded-full font-semibold border border-gray-400 text-gray-700 hover:bg-gray-100 transition"
            onclick="retakeImage()">
            <i class="bi bi-arrow-counterclockwise"></i> Retake
          </button>
        </div>

        <!-- Hidden Form -->
        <form id="webcam-form" method="POST" enctype="multipart/form-data" class="hidden">
          {% csrf_token %}
          <input type="hidden" name="webcam_image" id="webcam-image">
        </form>
      </div>
    </div>

    <!-- Right-side Form Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      {% include "ocr/right_form.html" %}
    </div>

  </div>
</div>

<!-- Bootstrap Icons (optional for icons) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script>
  const video = document.getElementById('webcam');
  const canvas = document.getElementById('canvas');
  const preview = document.getElementById('captured-preview');
  const captureBtn = document.getElementById('capture-btn');
  const sendBtn = document.getElementById('send-btn');
  const retakeBtn = document.getElementById('retake-btn');
  const webcamForm = document.getElementById('webcam-form');
  const webcamImage = document.getElementById('webcam-image');

  // Start webcam
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: { ideal: 1920 }, height: { ideal: 1080 }, facingMode: "environment" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    } catch (err) {
      alert("Unable to access camera: " + err.message);
    }
  }

  // Capture
  function captureImage() {
    video.classList.add("blur-sm", "brightness-75");
    setTimeout(() => {
      const track = video.srcObject.getVideoTracks()[0];
      const settings = track.getSettings();

      canvas.width = settings.width || video.videoWidth;
      canvas.height = settings.height || video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const dataURL = canvas.toDataURL("image/jpeg", 1.0);
      preview.src = dataURL;
      preview.classList.remove("hidden");
      webcamImage.value = dataURL;

      video.classList.add("hidden");
      captureBtn.classList.add("hidden");
      sendBtn.classList.remove("hidden");
      retakeBtn.classList.remove("hidden");
    }, 250);
  }

  // Retake
  function retakeImage() {
    preview.classList.add("hidden");
    video.classList.remove("hidden");
    video.classList.remove("blur-sm", "brightness-75");
    sendBtn.classList.add("hidden");
    retakeBtn.classList.add("hidden");
    captureBtn.classList.remove("hidden");
  }

  // Send
  function sendImage() {
    webcamForm.submit();
  }

  startCamera();
</script>

{% endblock %}